name: CICD with Auto Release

on:
  push:
    branches: [ master ]

permissions:
  contents: write

jobs:
  auto-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.actor != 'github-actions'
    concurrency:
      group: auto-version-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version
        id: update-version
        run: |
          CURRENT_VERSION=$(grep 'VERSION' version.cpp | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"

          SLIDE1=$(echo $CURRENT_VERSION | cut -d. -f1)
          SLIDE2=$(echo $CURRENT_VERSION | cut -d. -f2)
          SLIDE3=$(echo $CURRENT_VERSION | cut -d. -f3)

          NEW_SLIDE3=$((SLIDE3 + 1))
          NEW_SLIDE2=$SLIDE2
          NEW_SLIDE1=$SLIDE1

          if [ $NEW_SLIDE3 -ge 10 ]; then
            NEW_SLIDE3=0
            NEW_SLIDE2=$((SLIDE2 + 1))

            if [ $NEW_SLIDE2 -ge 10 ]; then
              NEW_SLIDE2=0
              NEW_SLIDE1=$((NEW_SLIDE1 + 1))
            fi
          fi

          NEW_VERSION="$NEW_SLIDE1.$NEW_SLIDE2.$NEW_SLIDE3"
          echo "New Version: $NEW_VERSION"

          sed -i "s/const char\* VERSION = \".*\"/const char* VERSION = \"$NEW_VERSION\"/" version.cpp

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    outputs:
      new_version: ${{ steps.update-version.outputs.new_version }}

  
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Clean build directory
        run: |
          if (Test-Path build) {
            Remove-Item -Recurse -Force build
          }
      
      - name: Configure CMake
        run: cmake -S . -B build
        
      - name: Build with CMake
        run: cmake --build build --config Release

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean build directory
        run: rm -rf build

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build project
        run: cmake --build build --config Release

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: linux-release/

  create-release:
    needs: [build-windows, build-linux]  
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: windows-release

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: linux-release

      - name: Debug - List downloaded files
        run: |
          echo "Windows release contents:"
          ls -la windows-release/
          echo "Linux release contents:"
          ls -la linux-release/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }} 
          draft: false
          prerelease: false
          files: |
            windows-release/laboratory1.exe
            linux-release/laboratory1
            
          body: |
        
            - Build Number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}